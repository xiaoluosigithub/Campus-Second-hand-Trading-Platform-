# 已实现功能（后端）

## 概览
- 技术栈：Spring Boot 3.2、Java 17、MyBatis-Plus 3.5.5、Maven 3.9
- 数据库：MySQL（已按项目文档建表）
- 配置：`src/main/resources/application.properties` 已连接到本地数据库
- 构建：`mvn -q -DskipTests compile` 通过

## 数据层
- 实体（Entity）
  - `User` → `users`：`user_id` 自增、`username` 唯一、`password_hash`、`nickname`、`avatar_url`、`signature`、`role`、`created_at`、`updated_at`
  - `Product` → `products`：`product_id`、`seller_id`、`category_id`、`title`、`description`、`price`、`images`（JSON 自动映射为 `List<String>`）、`status`、`rejection_reason`、`view_count`、`created_at`、`updated_at`
  - `Category` → `categories`：`category_id`、`name`（唯一）、`sort_order`、`created_at`
  - `ShoppingCart` → `shopping_cart`：`cart_id`、`user_id`、`product_id`、`created_at`
  - `Order` → `orders`：`order_id`、`order_number`、`buyer_id`、`seller_id`、`product_id`、`product_title_snapshot`、`product_image_snapshot`、`transaction_price`、`shipping_name/phone/address`、`tracking_number`、`payment_method`、`status`、`created_at`、`updated_at`
  - `Message` → `messages`：`message_id`、`sender_id`、`receiver_id`、`content`、`is_read`、`created_at`
- JSON 映射
  - `Product.images` 使用 `JacksonTypeHandler`，并在类上启用 `@TableName(autoResultMap = true)`，保证 JSON ↔ `List<String>` 自动转换
- 时间类型
  - 所有 `created_at`/`updated_at` 使用 `LocalDateTime`
- Mapper（BaseMapper）
  - 已为所有实体创建 `Mapper` 接口并标注 `@Mapper`

## 服务层（Service）
- 通用 CRUD 与分页
  - `UserService`：`create/getById/getByUsername/list(update/deleteById)`
  - `ProductService`：`create/getById/list(update/deleteById)`（支持按 `sellerId/categoryId/keyword` 的筛选）
  - `CategoryService`：`create/getById/list(update/deleteById)`
  - `ShoppingCartService`：`create/getById/listByUser(update/deleteById)`
  - `OrderService`：`create/getById/listByBuyer/listBySeller(update/deleteById)`
  - `MessageService`：`create/getById/listConversation(update/deleteById)`（按双方 `senderId/receiverId` 聚合）

## 认证与会话
- 统一响应包装
  - `ApiResponse`：成功 `code=200`、失败返回错误码与消息（HTTP 状态码同步为 400/422）
  - `GlobalExceptionHandler`：处理 `MethodArgumentNotValidException`（422）与 `IllegalArgumentException`（400），并通过 `@ResponseStatus` 返回正确的 HTTP 状态
- 登录拦截（HttpSession）
  - `LoginInterceptor` 检查 Session 的 `userId`，无登录态返回 401
  - `WebConfig` 注册拦截器：
    - 对 `/api/**` 生效
    - 放行 `/api/auth/**`；拦截器按方法+路径放行 `GET /api/products`、`GET /api/products/{id}`、`GET /api/categories/tree`、`GET /api/categories/{id}/path`
- 认证接口（Controller）
  - `POST /api/auth/register`：BCrypt 哈希存储密码；账号重复返回 409；新增 `confirmPassword` 字段并校验一致（不一致返回 400）
  - `POST /api/auth/login`：校验成功后写入 Session（`userId/nickname/role`），返回基础用户信息；失败文案区分“账号不存在/密码错误”（均为 401）
  - `POST /api/auth/logout`：清理会话
  - 依赖：`spring-security-crypto`（BCrypt）已在 `pom.xml` 添加

## 商品浏览接口
- 控制器：`/api/products`
  - `GET /api/products`：分页查询（参数 `page` 默认 1；`size` 默认 10，范围 1–50；`category`、`keyword` 可选；`sort=price_asc|price_desc|newest`，默认 `newest`）
  - `GET /api/products/{id}`：详情查询；不存在返回 400
  - 排序：`newest` → `createdAt` 降序；`price` → 价格升序

## 文档与示例
- 接口文档：`document/接口文档.md`
  - 已包含认证、商品浏览与商品发布/编辑/状态/我的商品/购物车/订单流转/后台的请求/响应示例、错误码说明、curl 调用示例，并补充了并发下单与支付方式校验失败示例。
  - 新增：商品列表 `excludeActive` 参数；商品删除与取消发布；管理员用户管理与订单列表/详情接口；编辑商品“待审核不可编辑”说明。
  - 新增：个人资料编辑接口 `PATCH /api/users/me/profile`；商品列表与我的商品的 `status/keyword` 筛选能力；购物车聚合列表 `GET /api/cart/items`；订单统计返回 `amountCompleted` 字段。

## 验证方法（示例）
- 注册：`POST /api/auth/register`（JSON：`username/password/nickname`）
- 登录：`POST /api/auth/login`（返回 `JSESSIONID`；后续接口携带 Cookie）
- 商品列表：`GET /api/products?page=1&size=10&category=2&keyword=iphone`
- 商品详情：`GET /api/products/{id}`
- 登出：`POST /api/auth/logout`
- 发布商品：`POST /api/products`（标题、价格、分类、images）
- 编辑商品：`PUT /api/products/{id}`（仅价格/描述；编辑后回到待审核）
- 修改状态：`PATCH /api/products/{id}/status`（在售 1 / 下架 4）
- 我的商品：`GET /api/products/me?page&size&sort`
 - 添加购物车：`POST /api/cart`（`productId`）
 - 查询购物车：`GET /api/cart?page&size`
 - 移除购物车项：`DELETE /api/cart/{productId}`
 - 清除失效商品：`POST /api/cart/cleanup`
 - 创建订单：`POST /api/orders`（单品结算：`productId` + 收货信息）
- 取消订单：`POST /api/orders/{id}/cancel`
 - 发货：`PATCH /api/orders/{id}/ship`（卖家，填写物流单号）
 - 确认收货：`PATCH /api/orders/{id}/confirm`（买家确认）
 - 我买到的：`GET /api/orders/me/bought?page&size`
- 我卖出的：`GET /api/orders/me/sold?page&size`
 - 消息记录：`GET /api/messages?contactId={id}&page&size`
 - 发送消息：`POST /api/messages`（receiverId, content）
 - 最近联系人：`GET /api/messages/contacts`
 - 未读数量：`GET /api/messages/unread/count`
- 标记已读：`POST /api/messages/{id}/read`
 - 当日订单统计：`GET /api/admin/stats/orders?date=YYYY-MM-DD`
- 区间订单统计：`GET /api/admin/stats/orders-range?start=YYYY-MM-DD&end=YYYY-MM-DD`
 - 分类树：`GET /api/categories/tree`
 - 分类面包屑：`GET /api/categories/{id}/path`
 - 上传图片：`POST /api/files/upload`（multipart，返回 `/uploads/...`）
 - 支付模拟：`POST /api/pay/mock?orderId=...&method=alipay`（与订单支付方式不一致时返回 400）

## 与 PRD 对应关系（阶段性）
- 主页商品浏览：已实现分页、关键词/分类筛选与排序（`sort=price|newest`）
- 登录/注册：已实现，并使用 Session 维护登录态
- 个人主页/发布/管理：后端已实现商品发布、编辑、上下架与“我的商品”接口（编辑后回到待审核；上下架仅支持在售/下架；待审核不可编辑；支持删除/取消发布，严格遵守数据库约束；支持个人资料编辑：头像/昵称/签名；“我的商品”支持状态与名称筛选）
- 购物车/并发校验/下单流程：已实现
  - 并发校验：下单时使用行级锁（`SELECT ... FOR UPDATE`）与“进行中订单计数”校验，避免重复下单；仅在售商品可下单。
  - 流转：创建订单→状态`0`（待发货）；卖家发货→状态`1`（待收货）；买家确认→状态`2`（已完成），并将商品状态更新为`3`（已售出）；取消订单→状态`3`（已取消）。
  - 支付方式：仅允许 `alipay` 或 `wechat`；支付模拟需与订单方式一致（不一致返回 400）。
  - 列表展示：支持可选参数 `excludeActive=true` 过滤进行中订单商品（体验增强）；支持 `sort=price_asc|price_desc|newest`。
- 消息模块（留言板）：已实现对话查询、发送、联系人聚合、未读计数与标记已读
 - 管理后台（审核/分类/用户/订单）：已实现商品审核与分类基础 CRUD（管理员权限拦截），并提供管理员用户管理与订单列表/详情接口；审核驳回时必须填写理由（非空校验）。
 - 订单统计：已实现按日与区间统计接口（管理员权限），并返回 `amountCompleted`（仅已完成金额）。
- 分类导航：提供分类树与面包屑接口（当前平铺结构）
- 发布辅助：提供图片上传接口并映射静态资源
- 支付模拟：提供支付成功提示接口用于前端联调演示

- 个人资料编辑：`PATCH /api/users/me/profile`（JSON：`nickname/avatarUrl/signature`）；返回体不包含密码哈希（敏感字段屏蔽）。
- 我的商品筛选：`GET /api/products/me?page=1&size=10&status=1&keyword=iphone&sort=newest`
- 商品列表状态筛选：`GET /api/products?page=1&size=10&status=1&keyword=iphone`
 - 订单预校验：`GET /api/orders/precheck?productId=1001`（返回是否在售且无进行中订单）
