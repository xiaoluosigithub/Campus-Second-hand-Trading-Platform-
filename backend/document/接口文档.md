# 接口文档（当前进度）

## 基础说明
- 基础地址：本地后端默认端口（示例 `http://localhost:8080`）
- 请求与响应：`Content-Type: application/json`
- 认证机制：基于服务端 Session（登录成功后返回 `Set-Cookie: JSESSIONID=...`），后续受保护接口需在请求头携带该 Cookie。
- 统一响应结构：
  - `{"code":200,"message":"OK","data":...}`
  - 失败：`{"code":<错误码>,"message":"错误信息"}`

## 错误码约定
- 200：成功
- 400：请求参数不合法（服务端抛出 `IllegalArgumentException`）
- 401：未登录或账号密码错误
- 409：资源冲突（如注册账号已存在）
- 422：参数校验失败（`jakarta validation`）

## 认证接口

### 注册
- `POST /api/auth/register`
- 请求体：
  ```json
  {
    "username": "alice",
    "password": "123456",
    "confirmPassword": "123456",
    "nickname": "Alice"
  }
  ```
- 响应：201
  ```json
  {"code":200,"message":"OK","data": 1}
  ```
- 失败示例（账号已存在）：409
  ```json
  {"code":409,"message":"当前账号已存在"}
  ```
- 失败示例（两次输入密码不一致）：400
  ```json
  {"code":400,"message":"两次输入密码不一致"}
  ```
- 说明：后端使用 BCrypt 存储密码哈希。

### 登录
- `POST /api/auth/login`
- 请求体：
  ```json
  {
    "username": "alice",
    "password": "123456"
  }
  ```
- 响应：200（同时返回 `Set-Cookie: JSESSIONID=...`）
  ```json
  {
    "code":200,
    "message":"OK",
    "data": {"userId":1,"nickname":"Alice","role":"user"}
  }
  ```
- 失败示例：
  ```json
  {"code":401,"message":"账号不存在"}
  ```
  ```json
  {"code":401,"message":"密码错误"}
  ```

### 登出
- `POST /api/auth/logout`
- 响应：200
  ```json
  {"code":200,"message":"OK","data": null}
  ```

### 受保护接口与放行策略
- 受保护：`/api/**` 默认需要登录态（Session）。
- 放行白名单：`/api/auth/**`、`GET /api/products`、`GET /api/products/{id}`、`GET /api/categories/tree`、`GET /api/categories/{id}/path`。

## 商品接口（浏览）

### 列表查询
- `GET /api/products`
- 查询参数：
  - `page`（默认 1）
  - `size`（默认 10，范围 1–50）
  - `category`（可选，分类 ID）
  - `status`（可选，整数；按商品状态过滤）
  - `keyword`（可选，按标题模糊）
  - `sort`（可选：`price_asc|price_desc|newest`，默认 `newest`）
  - `excludeActive`（可选，布尔；为 `true` 时过滤存在进行中订单（status=0/1）的商品）
- 响应：200
  ```json
  {
    "code":200,
    "message":"OK",
    "data": {
      "records": [
        {
          "productId": 1001,
          "sellerId": 1,
          "categoryId": 2,
          "title": "iPhone 13",
          "description": "95新，未维修",
          "price": 3999.00,
          "images": ["https://via.placeholder.com/150"],
          "status": 1,
          "rejectionReason": null,
          "viewCount": 12,
          "createdAt": "2025-11-23T10:00:00",
          "updatedAt": "2025-11-23T10:00:00"
        }
      ],
      "total": 1,
      "size": 10,
      "current": 1,
      "pages": 1
    }
  }
  ```
- 失败示例（size 越界）：400
  ```json
  {"code":400,"message":"size范围为1-50"}
  ```

### 详情
- `GET /api/products/{id}`
- 响应：200（包含卖家信息，浏览量已递增）
  ```json
  {
    "code":200,
    "message":"OK",
    "data": {
      "product": {
        "productId": 1001,
        "sellerId": 1,
        "categoryId": 2,
        "title": "iPhone 13",
        "description": "95新，未维修",
        "price": 3999.00,
        "images": ["https://via.placeholder.com/150"],
        "status": 1,
        "rejectionReason": null,
        "viewCount": 13,
        "createdAt": "2025-11-23T10:00:00",
        "updatedAt": "2025-11-23T10:00:00"
      },
      "sellerId": 1,
      "sellerNickname": "Alice",
      "sellerAvatarUrl": "https://example.com/avatars/alice.png"
    }
  }
  ```
- 失败示例（不存在）：400
  ```json
  {"code":400,"message":"商品不存在"}
  ```

## 示例调用（curl）

### 注册
```bash
curl -i -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"123456","nickname":"Alice"}'
```

### 登录（保存 Cookie）
```bash
curl -i -c cookies.txt -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"123456"}'
```

### 商品列表
```bash
curl -s "http://localhost:8080/api/products?page=1&size=10&category=2&keyword=iphone&sort=newest"
```

### 商品详情
```bash
curl -s http://localhost:8080/api/products/1001
```

### 登出
```bash
curl -b cookies.txt -X POST http://localhost:8080/api/auth/logout
```

## 数据结构说明

### Product（部分字段）
- `productId`（int）：商品主键
- `sellerId`（int）：卖家用户 ID
- `categoryId`（int）：分类 ID
- `title`（string）：标题
- `description`（string）：描述
- `price`（number）：价格（BigDecimal）
- `images`（string[]）：图片 URL 列表（JSON 自动映射）
- `status`（int）：状态（0 待审核 / 1 在售 / 2 审核未通过 / 3 已售出 / 4 已下架）
- `rejectionReason`（string|null）：驳回原因
- `viewCount`（int）：浏览量
- `createdAt`、`updatedAt`（string ISO8601）：时间

## 商品接口（发布与管理）

### 发布商品（登录）
- `POST /api/products`
- 请求体：
```json
{
  "title": "iPhone 13",
  "description": "95新，未维修",
  "price": 3999.00,
  "categoryId": 2,
  "images": ["https://via.placeholder.com/150"]
}
```
- 响应：200
```json
{"code":200,"message":"OK","data": 1001}
```

### 编辑商品（仅价格/描述，登录，本人资源）
- `PUT /api/products/{id}`
- 请求体：
```json
{
  "price": 3899.00,
  "description": "更优惠的价格"
}
```
- 响应：200
```json
{"code":200,"message":"OK","data": null}
```

### 修改状态（在售/下架，登录，本人资源）
- `PATCH /api/products/{id}/status`
- 请求体：
```json
{"status": 1}
```
- 说明：仅支持 `status=1（在售）` 或 `status=4（下架）`

### 我的商品（登录）
- `GET /api/products/me?page=1&size=10&status=1&keyword=iphone&sort=newest`
- 响应：分页结构同商品列表

## 排序说明
- 列表支持 `sort=price_asc|price_desc|newest`
- `price_asc`：价格升序
- `price_desc`：价格降序
- `newest`：按创建时间降序（默认）

## 购物车接口

### 添加到购物车（登录）
- `POST /api/cart`
- 请求体：
```json
{"productId": 1001}
```
- 响应：200
```json
{"code":200,"message":"OK","data": null}
```
- 失败说明：待审核商品不可编辑（返回 400）

### 查询我的购物车（登录）
- `GET /api/cart?page=1&size=10`
- 响应：分页结构（购物车项列表），每项包含 `userId/productId/createdAt`

### 移除购物车单品（登录）
- `DELETE /api/cart/{productId}`
- 响应：200（无数据）

### 清除失效商品（登录）
- `POST /api/cart/cleanup`
- 响应：200（返回删除数量）

### 聚合列表（登录）
- `GET /api/cart/items?page=1&size=10`
- 响应：分页结构，记录包含 `productId/title/price/status/image/addedAt`

## 订单接口（单品结算）

### 创建订单（登录，单品结算）
- `POST /api/orders`
- 请求体：
```json
{
  "productId": 1001,
  "shippingName": "张三",
  "shippingPhone": "13800001111",
  "shippingAddress": "北京市海淀区XX路XX号",
  "paymentMethod": "alipay"
}
```
- 响应：200（返回新订单ID）
```json
{"code":200,"message":"OK","data": 5001}
```
- 失败示例：
```json
{"code":400,"message":"商品已失效或非在售"}
```
```json
{"code":400,"message":"商品已被抢先下单"}
```
```json
{"code":400,"message":"支付方式仅支持支付宝或微信"}
```

### 取消订单（登录，仅待发货）
- `POST /api/orders/{id}/cancel`
- 响应：200（无数据）
- 失败示例：
```json
{"code":400,"message":"仅待发货订单可取消"}
```

### 发货（登录，卖家）
- `PATCH /api/orders/{id}/ship`
- 请求体：
```json
{"trackingNumber":"SF123456789CN"}
```
- 失败示例：
```json
{"code":400,"message":"仅待发货订单可发货"}
```

### 确认收货（登录，买家）
- `PATCH /api/orders/{id}/confirm`
- 失败示例：
```json
{"code":400,"message":"仅待收货订单可确认"}
```
- 说明：确认收货后订单状态变更为“已完成”，对应商品状态将更新为“已售出（3）”。

### 我的订单（登录）
- 我买到的：`GET /api/orders/me/bought?page=1&size=10`
- 我卖出的：`GET /api/orders/me/sold?page=1&size=10`

## 后台管理接口（管理员）

### 商品审核
- `PATCH /api/admin/products/{id}/review`
- 请求体：
```json
{"approved": true, "reason": "描述不清"}
```
- 说明：仅待审核商品可审核；通过→在售，驳回→审核不通过（`reason` 必填且非空）

### 分类管理
- `GET /api/admin/categories?page=1&size=10`
- `POST /api/admin/categories`（请求体为分类对象，`name` 必填）
- `DELETE /api/admin/categories/{id}`

### 订单统计
- 日统计：`GET /api/admin/stats/orders?date=2025-11-23`
  - 响应：
  ```json
  {
    "code":200,
    "message":"OK",
    "data": {
      "total": 12,
      "amount": 32999.00,
      "amountCompleted": 28999.00,
      "status": {"pending":3,"shipped":2,"completed":6,"canceled":1}
    }
  }
  ```
- 区间统计：`GET /api/admin/stats/orders-range?start=2025-11-01&end=2025-11-23`
  - 返回字段同上（统计区间内）

## 备注
- 当前版本已提供“认证 + 商品浏览 + 发布/编辑/上下架/我的商品 + 购物车与下单 + 订单流转（发货/确认） + 后台审核/分类 + 消息模块基础接口”。

## 消息接口（留言板）

### 获取与某人消息记录（登录）
- `GET /api/messages?contactId={id}&page=1&size=10`
- 响应：分页结构，按时间倒序
  - 记录项新增用户资料字段：
    - `senderNickname`、`senderAvatarUrl`
    - `receiverNickname`、`receiverAvatarUrl`

### 发送消息（登录）
- `POST /api/messages`
- 请求体：
```json
{"receiverId": 2, "content": "你好"}
```

### 最近联系人列表（登录）
- `GET /api/messages/contacts`
- 响应：数组项包含 `contactId`、`lastAt`，以及：
  - `contactNickname`、`contactAvatarUrl`

### 未读消息数量（登录）
- `GET /api/messages/unread/count`
- 响应：`{"code":200,"message":"OK","data": 3}`

### 标记消息为已读（登录，接收者）
- `POST /api/messages/{id}/read`
## 分类导航

### 分类树
- `GET /api/categories/tree`
- 响应：全部分类数组（当前为平铺结构）

### 面包屑路径
- `GET /api/categories/{id}/path`
- 响应：数组，当前包含该分类本身（若后续引入父子结构将返回完整路径）

## 文件上传

### 上传图片（登录）
- `POST /api/files/upload`（`multipart/form-data`）
- 表单字段：`file`
- 响应：`{"code":200,"message":"OK","data":"/uploads/xxxx.png"}`
- 说明：仅支持 png/jpg/jpeg/webp，大小≤5MB；静态资源路径 `/uploads/**`

## 支付模拟

### 支付模拟（登录，买家）
- `POST /api/pay/mock?orderId=5001&method=alipay`
- 响应：`{"code":200,"message":"OK","data":"支付成功"}`
- 说明：用于前端流程演示，不改变订单业务状态；已取消订单不可支付；`method` 必须与订单 `paymentMethod` 一致，否则返回 400。
- 失败示例：
```json
{"code":400,"message":"支付方式与订单不一致"}
```

## 新增接口（商品管理与后台）

### 删除商品（登录，本人资源）
- `DELETE /api/products/{id}`
- 说明：仅待审核(0)/审核未通过(2)/已下架(4)可删除；存在关联订单时不可删除；删除前清理购物车中该商品。
- 失败示例：
```json
{"code":400,"message":"仅待审核/审核未通过/已下架可删除"}
```
```json
{"code":400,"message":"商品存在关联订单，无法删除"}
```

### 取消发布（登录，本人资源）
- `POST /api/products/{id}/cancel`
- 说明：在售(1)→下架(4)；若为 0/2/4 则按删除处理（需无关联订单）。
- 失败示例：
```json
{"code":400,"message":"商品存在关联订单，无法取消"}
```

### 用户管理（管理员）
- `GET /api/admin/users?page=1&size=10&keyword=alice`
- `PATCH /api/admin/users/{id}/role?role=user|admin`
- `DELETE /api/admin/users/{id}`（存在关联数据时返回错误）

### 订单列表与详情（管理员）
- `GET /api/admin/orders?page=1&size=10&buyerId=1&sellerId=2&status=1&date=2025-11-23`
- `GET /api/admin/orders/{id}`
## 用户接口

### 个人资料编辑（登录）
- `PATCH /api/users/me/profile`
- 请求体：
```json
{
  "nickname": "Alice",
  "avatarUrl": "/uploads/alice.png",
  "signature": "love trading"
}
```
- 响应：
```json
{"code":200,"message":"OK","data": null}
```
- 说明：登录态下更新本人资料；字段均为可选；返回空数据

### 获取个人资料（登录）
- `GET /api/users/me`
- 响应：返回当前登录用户完整资料（包含 `username/nickname/avatarUrl/signature/role/createdAt/updatedAt`）

## 订单辅助接口

### 订单预校验（登录）
- `GET /api/orders/precheck?productId=1001`
- 响应：
```json
{"code":200,"message":"OK","data": true}
```
- 说明：返回是否“在售且无进行中订单”；用于前端在进入确认页前的校验

## 示例（追加）

### 我的商品筛选
```bash
curl -b cookies.txt -s "http://localhost:8080/api/products/me?page=1&size=10&status=1&keyword=iphone&sort=newest"
```

### 商品列表状态筛选
```bash
curl -s "http://localhost:8080/api/products?page=1&size=10&status=1&keyword=iphone"
```

### 个人资料编辑
```bash
curl -b cookies.txt -X PATCH http://localhost:8080/api/users/me/profile \
  -H "Content-Type: application/json" \
  -d '{"nickname":"Alice","avatarUrl":"/uploads/alice.png","signature":"love trading"}'
```
