## 总体结论

* 后端整体与数据库模型高度一致，涵盖认证、商品浏览/发布、购物车、下单、订单流转、消息、后台审核/统计等主要接口，能支撑 PRD 的核心流程。

* 存在若干明显问题与和 PRD 的差距：安全性两处、错误码语义与 HTTP 状态不一致、分类层级与面包屑、管理员删除分类的异常处理、统计口径、注册确认密码、排序细节与购物车返回内容等。

## 明显问题与修复项

* 敏感信息泄露：`GET /api/users/me` 直接返回实体，包含 `passwordHash`。

  * 修复：改为返回精简 DTO（移除敏感字段），或在实体上给 `passwordHash` 添加 `@JsonIgnore`。

  * 位置：src/main/java/com/lyx/secondhandsystem/controller/UserController.java:48-55。

* 异常的 HTTP 状态不正确：全局异常处理仅写入响应体 `code=400/422`，HTTP 状态仍为 200。

  * 修复：在 `GlobalExceptionHandler` 的方法上添加 `@ResponseStatus`，或改为返回 `ResponseEntity` 设置状态码。

  * 位置：src/main/java/com/lyx/secondhandsystem/common/GlobalExceptionHandler.java:15-34。

* 登录拦截白名单过宽：`/api/products` 与 `/api/products/*` 被完全放行，导致写操作也绕过拦截器（虽然控制器里仍有 Session 校验，语义和状态码不一致）。

  * 修复：在登录拦截器里按方法 + 路径判断，仅放行 `GET /api/products` 和 `GET /api/products/{id}`；其余方法仍需登录。

  * 位置：src/main/java/com/lyx/secondhandsystem/config/WebConfig.java:15-24。

* 管理员删除分类异常处理缺失：删除被引用的分类会抛出数据约束异常并返回 500。

  * 修复：在 `AdminCategoryController` 删除接口捕获 `DataIntegrityViolationException`，返回友好错误（如“分类存在关联商品，无法删除”）。

  * 位置：src/main/java/com/lyx/secondhandsystem/controller/admin/AdminCategoryController.java:41-46。

* 订单统计金额口径：当前按区间内“所有订单”累计金额，包含已取消订单。

  * 修复：新增“仅已完成（status=2）订单金额”的统计，或将总额拆分为 `amountAll/amountCompleted`。

  * 位置：src/main/java/com/lyx/secondhandsystem/controller/admin/AdminStatsController.java:45-70。

* 配置安全：数据库密码硬编码在配置文件。

  * 修复：改为环境变量或本地开发配置文件，不随代码发布。

  * 位置：src/main/resources/application.properties:5-6。

## 与 PRD 的差距与补齐项

* 分类层级与面包屑：PRD 示例为多级面包屑，但数据库 `categories` 无层级字段，接口 `GET /api/categories/{id}/path` 仅返回自身。

  * 方案 A：为 `categories` 增加 `parent_id` 字段，补齐层级，`tree/path` 返回完整路径。

  * 方案 B：维持平铺，但商品维度保存“路径快照”用于面包屑（折中）。

  * 位置：src/main/java/com/lyx/secondhandsystem/controller/CategoryController.java:22-41。

* 注册确认密码：PRD 要求“两次输入密码不一致”后端提示；当前 DTO/接口未包含 `confirmPassword` 校验。

  * 修复：在 `RegisterRequest` 增加 `confirmPassword` 字段并在注册逻辑校验一致。

  * 位置：src/main/java/com/lyx/secondhandsystem/dto/RegisterRequest.java 与 src/main/java/com/lyx/secondhandsystem/controller/AuthController.java。

* 商品排序“价格高低”：当前仅支持价格升序。

  * 修复：扩展 `sort` 支持 `price_asc/price_desc/newest`。

  * 位置：src/main/java/com/lyx/secondhandsystem/service/impl/ProductServiceImpl.java:41-45。

* 购物车列表数据：PRD 展示商品卡片与“失效/已售出”标记，后端 `GET /api/cart` 仅返回购物车项，不含商品详情/状态。

  * 修复：在 `CartController.list` 返回时附带商品快照（标题/价格/状态/封面），或新增 `GET /api/cart/items` 聚合输出。

  * 位置：src/main/java/com/lyx/secondhandsystem/controller/CartController.java:58-72。

* 支付方式参数使用：`/api/pay/mock` 的 `method` 未参与校验/状态变更，语义和下单时 `paymentMethod` 校验分离。

  * 修复：`mock` 接口校验 `method` 与订单的 `paymentMethod` 一致，或移除该参数保持一致性；明确该接口不改变订单业务状态。

  * 位置：src/main/java/com/lyx/secondhandsystem/controller/PayController.java:19-32。

## 兼容性与正确性验证

* 单元验证：为用户资料接口、异常处理器、分类删除、商品排序与购物车聚合新增最小化测试用例，验证 HTTP 状态与响应结构。

* 联调验证：用接口文档中的 curl 流程跑通登录/发布/审核/下单/发货/确认，观察错误码与拦截器行为一致。

## 实施步骤（可分批提交）

1. 用户资料安全修复与异常状态码统一：

   * 新增 `UserProfileResponse` DTO 并替换 `GET /api/users/me` 返回；为异常处理器增加 `@ResponseStatus`（400/422）。
2. 登录拦截器白名单收紧：

   * 在 `LoginInterceptor.preHandle` 判定 `GET` 且路径匹配商品列表/详情才放行；删除 `WebConfig` 的路径排除或保留仅认证接口排除。
3. 管理员分类删除异常处理：

   * 捕获 `DataIntegrityViolationException` 并返回 400 + 友好提示。
4. 订单统计口径优化：

   * 统计结构增加 `amountCompleted` 字段；实现仅 `status=2` 的累计。
5. 注册接口补齐确认密码：

   * DTO 增加 `confirmPassword`，控制器校验一致性，返回 PRD 文案。
6. 商品排序细化：

   * 扩展 `sort` 参数为 `price_asc/price_desc/newest`，并更新接口文档。
7. 购物车聚合返回：

   * 在 `CartController.list` 附带商品快照字段，或新增聚合查询接口供前端使用。
8. 配置安全：

   * 将数据库密码改为环境变量读取，保留本地示例配置文件。

## 交付物

* 代码改动（控制器/拦截器/异常处理器/DTO/统计逻辑）。

* 接口文档更新（参数与响应示例）。

* 最小化测试用例与验证脚本。

