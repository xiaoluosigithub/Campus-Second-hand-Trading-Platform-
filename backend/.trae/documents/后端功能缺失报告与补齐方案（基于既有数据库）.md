## 现状概览（与数据库/PRD对齐）

* 数据库为准：users/products/categories/shopping\_cart/orders/messages 的结构与约束已在代码层正确映射；订单与商品状态流转已按数据库字典执行。

* 并发与一致性：下单使用行级锁（SELECT ... FOR UPDATE）与“进行中订单计数”校验；确认收货后商品状态更新为 3（已售出）。支付方式仅允许 alipay|wechat。

* 认证与拦截：Session 登录态与管理员拦截生效；静态资源映射已配置。

## 已实现（关键功能与代码参考）

* 认证与会话：注册/登录/注销，返回用户基本信息（src/main/java/com/lyx/secondhandsystem/controller/AuthController.java:31-72）。

* 商品：列表/详情/发布/编辑（编辑后置 0 待审核）/在售与下架（src/main/java/com/lyx/secondhandsystem/controller/ProductController.java:31-47,75-133）。

* 管理审核：仅待审核商品可审核，流转 0→1/2（src/main/java/com/lyx/secondhandsystem/controller/admin/AdminProductController.java:21-40）。

* 分类与导航：分类树（平铺）与面包屑（当前仅自身）（src/main/java/com/lyx/secondhandsystem/controller/CategoryController.java:22-41）。

* 购物车：添加/查询/移除/清除失效（按 status=1）（src/main/java/com/lyx/secondhandsystem/controller/CartController.java:31-107）。

* 订单：下单（并发校验）、发货、确认收货（置商品为 3）、取消（src/main/java/com/lyx/secondhandsystem/service/impl/OrderServiceImpl.java:71-158；src/main/java/com/lyx/secondhandsystem/controller/OrderController.java:24-33,35-66）。

* 消息：对话分页、发送、联系人聚合、未读计数、标记已读（src/main/java/com/lyx/secondhandsystem/controller/MessageController.java:33-135）。

* 管理后台统计：当日/区间统计（总数/金额/各状态计数）（src/main/java/com/lyx/secondhandsystem/controller/admin/AdminStatsController.java:26-77）。

* 文件上传：图片类型/大小校验与静态路径（src/main/java/com/lyx/secondhandsystem/controller/FilesUploadController.java:21-45；WebConfig.java:28-30）。

## 未实现/待完善（差距清单）

1. 商品删除/取消发布接口缺失（与个人中心操作要求）

* 期望：待审核/审核未通过/已下架状态支持“取消发布/删除”。

* 现状：仅有服务层 delete 能力，未提供 Controller 接口与状态约束。

1. 待审核状态不可编辑（后端约束缺失）

* 期望：待审核禁用编辑，审核未通过或在售/下架可编辑。

* 现状：PUT /api/products/{id} 未限制，任何状态可编辑并置为 0。

1. 管理后台用户管理未提供

* 期望：管理员用户列表、禁用/启用、角色变更、删除等接口。

* 现状：仅商品审核/分类/统计接口，缺少 /api/admin/users\*。

1. 管理后台订单列表与详情未提供

* 期望：管理员维度查看所有订单的分页与详情。

* 现状：仅买家/卖家维度查询。

1. 商品列表可视策略（体验增强）

* 期望：首页展示仅对用户“可购买”的在售商品；存在进行中订单的商品应隐藏或标注不可购买。

* 现状：列表展示 status=1 商品；进行中订单在下单阶段提示“已被抢先下单”。

1. 购物车并发添加的唯一键冲突处理（健壮性增强）

* 期望：并发场景下优雅处理唯一键冲突（忽略重复或捕获异常返回 200）。

* 现状：先查重后插入，可能出现极端并发冲突。

1. 实体注释与状态字典一致性（可选改进）

* 期望：Product/Order 实体注释与数据库字典完全一致，减少误读。

* 现状：Product.status 注释未包含 3/4；功能不受影响。

## 补齐方案（严格基于既有数据库）

1. 商品删除/取消发布接口

* 新增：DELETE /api/products/{id}（仅本人、允许状态：0/2/4；删除同时清理购物车项该 productId）。

* 新增：POST /api/products/{id}/cancel（仅本人、仅 0/2/4，语义：从在售 1→4 下架或从 0/2 直接删除）。

1. 编辑限制（待审核不可编辑）

* 在 PUT /api/products/{id} 增加状态判断：拒绝 0；允许 1/2/4，编辑后置 0 并清空驳回原因。

1. 管理后台用户管理

* 新增：GET /api/admin/users（分页）、PATCH /api/admin/users/{id}/role、PATCH /api/admin/users/{id}/disable、DELETE /api/admin/users/{id}，基于 users 表。

1. 管理后台订单列表与详情

* 新增：GET /api/admin/orders（分页筛选 buyer/seller/status/dateRange）、GET /api/admin/orders/{id}（详情）。

1. 商品列表过滤进行中订单（可选）

* 服务层 list 查询增加“NOT EXISTS 进行中订单（status IN 0,1）”过滤，或在响应中标注不可购买状态供前端隐藏操作。

1. 购物车并发健壮性

* 插入时捕获唯一键异常并返回 200；或改为数据库层“插入忽略”风格 SQL。

1. 注释一致性

* 更新 Product/Order 实体上的状态注释，仅改代码注释，不改数据库结构。

## 交付与验证

* 单元/集成验证：为新增接口补充最小集成测试（登录态前置、状态流转断言）。

* 文档更新：接口文档新增删除/取消发布、管理员用户与订单接口；“已实现功能”同步对应能力。

* 性能/并发：维持现有行级锁与计数校验策略，确保不改变数据库结构前提下的正确性。

## 约束声明

* 所有改动严格基于现有数据库结构与字典（/document/Database.md）；不新增或修改表结构，仅在服务与控制层完善逻辑与接口。

