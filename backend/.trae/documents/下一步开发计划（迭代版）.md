## 现状总结
- 已实现：注册/登录/登出（Session）、商品列表与详情、统一异常与响应包装、拦截器、实体/Mapper/Service 基础 CRUD。文档已更新。
- 与 PRD对应：主页商品浏览已具备分页与筛选，排序待接入；认证就绪；其余功能待迭代。

## 迭代目标（小步快跑）
- 按 PRD 分阶段落地：商品发布/管理 → 购物车与下单（并发校验） → 订单流转与后台审核 → 消息与图片占位。每阶段完成后更新接口文档与示例。

## M2：商品发布与管理（优先）
- 功能：
  - 发布商品：`POST /api/products`（登录；初始 `status=0` 待审核；`images` 传 URL 列表）
  - 编辑：`PUT /api/products/{id}`（仅价格/描述；编辑后回到 `status=0`）
  - 上/下架：`PATCH /api/products/{id}/status`（1 在售 / 4 下架）
  - 我的商品：`GET /api/products/me`（分页）
- 规则：
  - IDOR防护：写操作校验 `product.sellerId == currentUserId`，否则 403。
  - 校验：价格>0，标题非空，`images` 数量上限（如 9）。
  - 排序接入：列表支持 `sort=price|newest`（服务层：`orderByAsc(price)` 或 `orderByDesc(createdAt)`）。
- 文档：补充以上接口契约到 `document/接口文档.md`。
- 测试：编辑越权、下架越权、排序正确性、分页边界。

## M3：购物车与单品下单（核心并发）
- 购物车：
  - `POST /api/cart`（加入单品；重复添加返回提示）
  - `GET /api/cart`、`DELETE /api/cart/{productId}`、`POST /api/cart/cleanup`
- 下单（单品结算策略）：
  - `POST /api/orders`（参数：`productId` + `shippingName/phone/address`）
  - 事务步骤：校验在售且非自买 → 插入订单 `status=0` → 更新商品 `status=3 已售出` → 删除所有用户购物车中的该商品。
  - 取消订单：`POST /api/orders/{id}/cancel`（仅 `status=0`；事务回滚商品为在售，订单置取消）。
- 测试：自买拦截、商品失效拦截、并发下唯一售出、取消回滚。
- 文档：补充下单与购物车接口契约与示例。

## M4：订单流转与后台管理
- 订单：
  - 发货：`PATCH /api/orders/{id}/ship`（卖家填写 `trackingNumber` → `status=1`）
  - 确认收货：`PATCH /api/orders/{id}/confirm`（买家 → `status=2`）
  - 我的订单：`GET /api/orders/me/bought`、`GET /api/orders/me/sold`
  - IDOR防护：发货需验证卖家归属，确认需验证买家归属。
- 管理后台：
  - 商品审核：`PATCH /api/admin/products/{id}/review`（通过/不通过+原因；状态切换）
  - 分类管理：`GET/POST/DELETE /api/admin/categories`
- 测试：发货/确认越权、审核状态切换、分类唯一名校验。

## M5：消息简版与图片占位
- 消息：
  - `GET /api/messages?contactId={id}`、`POST /api/messages`、`GET /api/messages/contacts`
  - 对话查询使用双向条件聚合（已在 Service 实现基础上落地 Controller）。
- 图片占位（可选）：
  - `GET /api/mock/image` 返回占位图 URL，前端发布时可直接使用。

## 非功能与一致性
- 统一错误码与提示文本；分页默认与上限；日志与敏感信息不落盘。
- `Product.status` 语义与数据库一致（0 待审核 / 1 在售 / 2 审核不通过 / 3 已售出 / 4 已下架），修正实体注释。

## 文档与交付
- 每阶段完成后：更新 `document/接口文档.md`（契约、示例、错误码），更新 `document/已实现功能.md`（能力与验证说明）。
- 交付内容：可运行后端 + 用例集合（Postman/Apifox）+ 简要说明。

## 起步任务（确认后执行）
- 实现 M2：发布/编辑/上下架/我的商品；接入 `sort=price|newest`；完善接口文档与单测。